<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard ‚Äì EcoA√ß√£o</title>
    <style>
        :root { --p: #1b5e20; --s: #43a047; --bg: #f0f2f5; }
        /* Esconde o corpo da p√°gina at√© confirmar que N√ÉO √© admin */
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); display: none; }
        
        header { background: var(--p); color: white; padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; }
        .nav-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 15px; border-radius: 20px; cursor: pointer; margin-left: 10px; font-weight: bold; }
        
        .container { max-width: 900px; margin: 30px auto; padding: 0 20px; }
        
        /* Card de Perfil Organizado */
        .profile-card { background: white; border-radius: 20px; overflow: hidden; display: flex; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 30px; }
        .user-side { padding: 30px; flex: 1; background: linear-gradient(135deg, var(--p), var(--s)); color: white; }
        .score-side { padding: 30px; width: 200px; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; background: white; }
        
        .points-val { font-size: 3rem; font-weight: 800; color: var(--p); line-height: 1; }
        .points-lab { font-size: 0.8rem; color: #666; font-weight: bold; margin-top: 5px; }

        /* Grid de Hist√≥rico */
        .h-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .h-card { background: white; padding: 15px; border-radius: 15px; border-left: 6px solid #ccc; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .h-card.aprovada { border-left-color: #2e7d32; }
        .h-card.rejeitada { border-left-color: #d32f2f; }
        .status { font-size: 0.7rem; font-weight: 800; text-transform: uppercase; margin-bottom: 10px; display: block; }
        .h-card img { width: 100%; height: 150px; object-fit: cover; border-radius: 10px; margin-top: 10px; }

        @media (max-width: 600px) { .profile-card { flex-direction: column; } .score-side { width: 100%; } }
    </style>
</head>
<body id="body">

<header>
    <div style="font-weight:bold; font-size:1.2rem">üå± EcoA√ß√£o</div>
    <div>
        <button class="nav-btn" onclick="location.href='acoes.html'">+ A√ß√£o</button>
        <button class="nav-btn" onclick="logout()" style="background:#c62828">Sair</button>
    </div>
</header>

<div class="container">
    <div class="profile-card">
        <div class="user-side">
            <h2 id="txtNome" style="margin:0">Carregando...</h2>
            <p id="txtCurso" style="margin:10px 0 0; opacity: 0.9;">Curso: ---</p>
            <p id="txtEmail" style="margin:5px 0 0; font-size: 0.8rem; opacity: 0.7;">---</p>
        </div>
        <div class="score-side">
            <div class="points-val" id="txtPontos">0</div>
            <div class="points-lab">PONTOS</div>
        </div>
    </div>

    <h3 style="color:#444">Minhas Atividades</h3>
    <div id="historico" class="h-grid"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, onSnapshot, collection, query, where } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAgKsk6jSIQk7AQ35xmVpnSn84pU8ca0g8",
        authDomain: "ecoacao-eda80.firebaseapp.com",
        projectId: "ecoacao-eda80"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    onAuthStateChanged(auth, async (user) => {
        if (!user) { window.location.href = "login.html"; return; }

        const snap = await getDoc(doc(db, "usuarios", user.uid));
        if (snap.exists()) {
            const d = snap.data();
            
            // SE FOR ADMIN, N√ÉO DEIXA NEM VER A P√ÅGINA
            if (d.admin === true) {
                window.location.replace("admin.html");
                return; 
            }

            // SE N√ÉO FOR ADMIN, MOSTRA A P√ÅGINA
            document.getElementById("body").style.display = "block";
            document.getElementById("txtNome").innerText = d.nome || "Estudante";
            document.getElementById("txtCurso").innerText = d.curso || "---";
            document.getElementById("txtPontos").innerText = d.pontos || 0;
            document.getElementById("txtEmail").innerText = user.email;

            // Carrega Hist√≥rico em tempo real
            const q = query(collection(db, "acoes_pendentes"), where("uid", "==", user.uid));
            onSnapshot(q, (s) => {
                const h = document.getElementById("historico");
                h.innerHTML = "";
                s.forEach(docSnap => {
                    const acao = docSnap.data();
                    const card = document.createElement("div");
                    card.className = `h-card ${acao.status}`;
                    card.innerHTML = `
                        <span class="status" style="color:${acao.status === 'aprovada' ? 'green' : (acao.status === 'rejeitada' ? 'red' : '#b7791f')}">${acao.status || 'pendente'}</span>
                        <strong style="display:block; margin-bottom:5px">${acao.acao}</strong>
                        <small>Pontos: ${acao.pontos}</small>
                        ${acao.comprovanteBase64 ? `<img src="${acao.comprovanteBase64}">` : ''}
                    `;
                    h.appendChild(card);
                });
            });
        }
    });

    window.logout = () => signOut(auth).then(() => location.href = "login.html");
</script>
</body>
</html>
